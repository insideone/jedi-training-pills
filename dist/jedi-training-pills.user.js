// ==UserScript==
// @name        jedi-training-pills
// @version     1.0.0
// @author      insideone
// @description Report builder for Jedi Training group
// @match       https://steamcommunity.com/groups/JediTraining/announcements/detail/1689297920480934920
// @connect     www.steamgifts.com
// @connect     steamcommunity.com
// @grant       GM.xmlHttpRequest
// ==/UserScript==

!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s="/7QA")}({"/7QA":function(e,t,n){"use strict";n.r(t);var r=n("6I/Y");function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,(n=[{key:"from",value:function(e){return"string"==typeof e?(new DOMParser).parseFromString(e,"text/html"):e}},{key:"all",value:function(e,t){return this.from(e).querySelectorAll(t)}},{key:"one",value:function(e,t){var n=this.maybeOne(e,t);if(null===n)throw new Error("Can't find ".concat(this.describeQuery(e,t)));return n}},{key:"date",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"data-timestamp",r=this.one(e,t),i=this.createDate(r.getAttribute(n));if(!i)throw new Error("Can't find timestamp ".concat(this.describeQuery(e,"".concat(t,"[").concat(n,"]"))));return i}},{key:"maybeDate",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"data-timestamp";try{return this.date(e,t,n)}catch(e){return null}}},{key:"createDate",value:function(e){return null===e?null:new Date(1e3*Number(e))}},{key:"last",value:function(e,t){var n=this.all(e,t);if(0===n.length)throw new Error("Can't find any of ".concat(this.describeQuery(e,t)));return n[n.length-1]}},{key:"maybeOne",value:function(e,t){return this.from(e).querySelector(t)}},{key:"describeQuery",value:function(e,t){return"'".concat(t,"' in '").concat(this.describeContext(e),"'")}},{key:"describeContext",value:function(e){if("string"==typeof e||e instanceof Document)return"document";var t=[],n=e;do{var r=n.className.split(" ").join(".");t.unshift([n.nodeName.toLowerCase(),n.id?"#".concat(n.id):null,r?".".concat(r):null].filter((function(e){return!!e})).join("")),n=n.parentNode}while(n&&"HTML"!==n.nodeName);return t.join(" ")}},{key:"previous",value:function(e,t){for(var n=this.from(e);n=n.previousSibling;)if(t(n))return n;throw new Error("Can't find ".concat(this.describeQuery(e,"previous")))}}])&&i(t.prototype,n),r&&i(t,r),e}()),o=function(e){return Object(r.H)("a",Object.assign({className:"btn_green_white_innerfade btn_medium"},e),Object(r.H)("span",null,e.c))},u=n("8M53"),c=function(e){var t=new URL(e),n=t.pathname.split("/");return n.length<4&&n.push("_"),(n=n.slice(0,4)).push("winners"),t.pathname=n.join("/"),t.toJSON()},l=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=a.maybeOne(e,"".concat(t,' a[href^="/user/"]:not(:empty)').trim());return n?{name:n.textContent||"",url:n.getAttribute("href")||""}:null},s=function(e){try{return Number(e.match(/(\d+)P/)[1])}catch(e){return null}},f=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(e){return Promise.resolve(e)};return function(n,r,i){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=Object.assign({url:n,onload:r,onerror:i},e,a);t(o).then(GM.xmlHttpRequest).catch(o.onerror)}},h=new u.RateLimiter(2,"second"),m=null,d=f({method:"GET"},(function(e){return m=e.url,new Promise((function(t,n){h.removeTokens(1,(function(r){r&&n("".concat(r," while fetching ").concat(m||"unknown url")),t(e)}))}))})),v=function(e){return new Promise((function(t,n){return new Promise((function(t,n){return d(e.url,(function(e){var n=e.responseText;return t(n)}),n)})).then((function(t){var n=a.from(t),r=a.one(n,".forum_paging_summary"),i=Math.ceil(Number(a.one(r,'[id$="pagetotal"]').textContent)/Number(a.one(r,'[id$="pageend"]').textContent)),o=new URL(e.url);o.searchParams.set("ctp",String(i));var u=a.one(n,".forum_op .topic").textContent;e.value=s(u),e.lastPageUrl=String(o)})).then((function(){return new Promise((function(t,n){return d(e.lastPageUrl,(function(e){var n=e.responseText;return t(n)}),n)}))})).then((function(t){var r,i=a.one(t,".commentthread_comment:last-child"),o=a.one(i,".commentthread_author_link");try{r=a.last(i,'.bb_link[href*="https://www.steamgifts.com/giveaway"]')}catch(e){return void n("Can't find a giveaway url in the last post of topic. Is it derailed?")}e.head={giveaway:{winners:[],url:c(r.textContent||"")},creator:{name:a.one(o,"bdi").textContent||"",url:o.getAttribute("href")||""},post:{url:e.url+a.one(i,".forum_comment_permlink a").getAttribute("href"),createdAt:a.date(i,".commentthread_comment_timestamp"),updatedAt:a.maybeDate(i,".forum_audit span[data-timestamp]")},warnings:[]}})).then((function(){return new Promise((function(t,n){return d(e.head.giveaway.url,(function(e){var n=e.responseText;return t(n)}),n)}))})).then((function(t){var r,i=a.from(t);try{r=a.one(i,".featured__heading__medium").textContent||"Unknown"}catch(e){return void n("Can't find the giveaway name. Is it deleted?")}Object.assign(e.head.giveaway,{endingAt:a.maybeDate(i,".featured__columns .featured__column:first-child span[data-timestamp]"),creator:l(i,".featured__column--width-fill"),winners:Array.from(i.querySelectorAll(".page__inner-wrap .table .table__row-inner-wrap")).map((function(e){return{user:l(e),status:(a.one(e,"div:last-child").textContent||"").trim()}})),app:{name:r,url:a.one(i,'.featured__inner-wrap a[href^="https://store.steampowered.com/"]').getAttribute("href")||""}})})).catch((function(e){n(e)})).finally((function(){console.log({train:e}),t(e)}))}))},b=n("XsWv"),p=n.n(b),g=function(e){return Object(r.H)("div",{className:"bb_table"},e.c)},y=function(e){return Object(r.H)("div",{className:"bb_table_tr"},e.c)},k=function(e){return Object(r.H)("div",{className:"bb_table_th"},e.c)},w=function(e){return Object(r.H)("div",{className:"bb_table_td"},e.c)},O=function(e){return"https://www.steamgifts.com".concat(e)},j=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return e.map((function(e){try{return e()}catch(e){return t}}))},T=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return function(n){return n(j([e],t)[0])}},H=function(e){var t=e.trains;return Object(r.H)(g,null,Object(r.H)(y,null,Object(r.H)(k,null,"Name"),Object(r.H)(k,null,"User"),Object(r.H)(k,null,"Updated"),Object(r.H)(k,null,"Giveaway"),Object(r.H)(k,null,"Store"),Object(r.H)(k,null,"Ending"),Object(r.H)(k,null,"Winners"),Object(r.H)(k,null,"Problems")),t.map((function(e){var t=j([function(){return{name:e.head.giveaway.creator.name,url:O(e.head.giveaway.creator.url)}},function(){return e.head.creator}]).find((function(e){return e}));return Object(r.H)(y,null,Object(r.H)(w,null,Object(r.H)("a",{href:e.url,target:"_blank"},e.name)),Object(r.H)(w,null,t?Object(r.H)("a",{href:t.url,target:"_blank"},t.name):[]),Object(r.H)(w,null,T((function(){return e.head.post}))((function(t){return t?p()(e.head.post.updatedAt?e.head.post.updatedAt:e.head.post.createdAt):[]}))),Object(r.H)(w,null,T((function(){return{name:e.head.giveaway.app.name,url:e.head.giveaway.url}}))((function(e){return e?Object(r.H)("a",{href:e.url,target:"_blank"},e.name):[]}))),Object(r.H)(w,null,T((function(){return e.head.giveaway.app.url}))((function(e){return e?Object(r.H)("a",{href:e,target:"_blank"},Object(r.H)("img",{src:"https://steamstore-a.akamaihd.net/public/shared/images/userreviews/icon_review_steam.png",alt:""})):[]}))),Object(r.H)(w,null,T((function(){return e.head.giveaway.endingAt}))((function(e){return e?p()(e):[]}))),Object(r.H)(w,null,T((function(){return e.head.giveaway.winners}),[])((function(e){return e.map((function(e){return"Received"===e.status?Object(r.H)("a",{href:O(e.user.url),target:"_blank"},e.user.name):Object(r.H)("span",null,"Anonymous")}))}))),Object(r.H)(w,null,e.problems.map((function(e){return Object(r.H)("p",null,e)}))))})))};var _=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.length===j(t).filter((function(e){return void 0!==e})).length};function x(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var n=[],r=!0,i=!1,a=void 0;try{for(var o,u=e[Symbol.iterator]();!(r=(o=u.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){i=!0,a=e}finally{try{r||null==u.return||u.return()}finally{if(i)throw a}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var S=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.trains=0,this.points=0,this.wins=0,this.user=t},I=function(e){var t=e.trains,n=Object.values(t.reduce((function(e,t){if(!_((function(){return t.head.giveaway.creator.url})))return e;var n=t.head.giveaway.creator.url;return n in e||(e[n]=new S(t.head.giveaway.creator)),e[n].trains++,_((function(){return t.head.giveaway.winners}))&&t.head.giveaway.winners.forEach((function(n){n.user&&(n.user.url in e||(e[n.user.url]=new S(n.user)),e[n.user.url].points+=t.value||0,e[n.user.url].wins++)})),e}),{})).sort((function(e,t){return e.points>t.points?-1:e.points===t.points?0:1})).reduce((function(e,t){return e[t.user.url]=t,e}),{});return Object(r.H)(g,null,Object(r.H)(y,null,Object(r.H)(k,null,"User"),Object(r.H)(k,null,"Ongoing"),Object(r.H)(k,null,"Pending"),Object(r.H)(k,null,"Pending in Points")),Object.entries(n).map((function(e){var t=x(e,2)[1];return Object(r.H)(y,null,Object(r.H)(w,null,Object(r.H)("a",{href:O(t.user.url),target:"_blank"},t.user.name)),Object(r.H)(w,null,t.trains),Object(r.H)(w,null,t.wins),Object(r.H)(w,null,t.points))})))},P=function(e){return e instanceof Error?e.message:"string"==typeof e?e:String(e)},B=["Birthday Train","Christmas Train","New Year Train","Jedi Train","Mystery Train"],A=/Monthly Train/,N=function(e,t,n){var i=t.trains,u=void 0===i?[]:i,c=t.errors,l=void 0===c?[]:c,s=t.trainsCount,f=void 0===s?0:s,h=t.loading,m=void 0!==h&&h;return Object(r.H)("div",{className:"jedi-training-pills"},Object(r.H)(o,{onclick:m?function(){return alert("Restarting isn't supported. Please, wait until finished or reload the page")}:function(){var e=[];for(Array.from(document.querySelectorAll(".bodytext a")).map((function(t){try{e.push({url:t.getAttribute("href")||"",name:a.previous(t,(function(e){return e.nodeType===Node.TEXT_NODE})).textContent,problems:[]})}catch(e){}})),e=e.filter((function(e){return e.url&&e.name&&!B.includes(e.name)&&!e.name.match(A)}));u.length;)u.pop();for(;l.length;)l.pop();n({loading:!0,trainsCount:e.length,trains:u,errors:l}),new Promise((function(t){!function e(r){if(0!==r.length){var i=r.shift();v(i).then((function(){})).catch((function(e){i.problems.push(P(e))})).finally((function(){u.push(i),n({trains:u}),e(r)}))}else t(u)}(e)})).finally((function(){n({loading:!1})}))}},"Report",f>0?Object(r.H)("span",null," (","".concat(u.length,"/").concat(f),")"):[]),Object(r.H)("hr",null),u.length>0?Object(r.H)("div",null,Object(r.H)("h2",null,"By Train"),Object(r.H)(H,{trains:u}),Object(r.H)("hr",null),Object(r.H)("h2",null,"By User"),Object(r.H)(I,{trains:u}),Object(r.H)("hr",null)):[],l.length>0?Object(r.H)("div",null,Object(r.H)("h2",null,"Errors"),Object(r.H)("ul",null,l.map((function(e){return Object(r.H)("li",null,e)})))):[])},C=document.createElement("div");C.classList.add("jedi-training-pills");var E=a.one(document,".announcement_body");E.parentElement.insertBefore(C,E),Object(r.R)(Object(r.H)(N),C)},"2qve":function(e,t,n){(function(t){var r=n("ovfc"),i=n("kzmp"),a=function(e,t,n){this.tokenBucket=new r(e,e,t,null),this.tokenBucket.content=e,this.curIntervalStart=i(),this.tokensThisInterval=0,this.fireImmediately=n};a.prototype={tokenBucket:null,curIntervalStart:0,tokensThisInterval:0,fireImmediately:!1,removeTokens:function(e,n){if(e>this.tokenBucket.bucketSize)return t.nextTick(n.bind(null,"Requested tokens "+e+" exceeds maximum tokens per interval "+this.tokenBucket.bucketSize,null)),!1;var r=this,a=i();if((a<this.curIntervalStart||a-this.curIntervalStart>=this.tokenBucket.interval)&&(this.curIntervalStart=a,this.tokensThisInterval=0),e>this.tokenBucket.tokensPerInterval-this.tokensThisInterval){if(this.fireImmediately)t.nextTick(n.bind(null,null,-1));else{var o=Math.ceil(this.curIntervalStart+this.tokenBucket.interval-a);setTimeout((function(){r.tokenBucket.removeTokens(e,u)}),o)}return!1}return this.tokenBucket.removeTokens(e,u);function u(t,i){if(t)return n(t,null);r.tokensThisInterval+=e,n(null,i)}},tryRemoveTokens:function(e){if(e>this.tokenBucket.bucketSize)return!1;var t=i();if((t<this.curIntervalStart||t-this.curIntervalStart>=this.tokenBucket.interval)&&(this.curIntervalStart=t,this.tokensThisInterval=0),e>this.tokenBucket.tokensPerInterval-this.tokensThisInterval)return!1;var n=this.tokenBucket.tryRemoveTokens(e);return n&&(this.tokensThisInterval+=e),n},getTokensRemaining:function(){return this.tokenBucket.drip(),this.tokenBucket.content}},e.exports=a}).call(this,n("8oxB"))},"6I/Y":function(e,t){var n=void 0!==n&&n||{};e.exports=n,(e=>{let t=(e=[],t)=>e.map(e=>e(t)),n=(e,t,...n)=>({$:e,a:!t||t.$||t.concat||t.toFixed?{c:[].concat(t||[],...n)}:(t.c=[].concat(...n),t)}),r=e=>new Proxy(e,{get:(e,t,n)=>r((...r)=>((n=e(...r)).a.className=(n.a.className||" ")+" "+t,n))}),i=e.R=(e,n,r=n.e||{},a=(n.e={}),o=((t,r)=>(t.$||r).bind?o(t.$(t.a,r.s,t=>Object.assign(r.s,t)&&i(e,n),r),r):t),u=((e,t,n)=>(t.$?Object.keys(t.a).map(n=>"style"==n?Object.assign(e[n],t.a[n]):e[n]==t.a[n]?e:e[n]=t.a[n])&&(t.a.k=n.k)&&(n.r||i(t.a.c,e)):e.data==t||(e.data=t),Object.assign(e,n),a[n.k]=e)),c={})=>[].concat(e).map((e,i,a,l=(e.a||e).k||" "+e.$+(c[e.$]=(c[e.$]||1)+1),s=r[l],f={k:l,s:(s||e).s||{},m:[],u:[],d:[]},h=o(e,f))=>t(u(e=(n.childNodes[i]||h).k!=l?n.insertBefore(s||(h.$?document.createElement(h.$):document.createTextNode(h)),n.childNodes[i]):s,h,f)==s?f.d:f.m,e))&&Object.keys(r).map(e=>a[e]||t(r[e].u,r[e])&&i([],n.removeChild(r[e])));e.H=new Proxy(n,{get:(e,t)=>n[t]||r(n.bind(n,t))})})(n)},"8M53":function(e,t,n){t.RateLimiter=n("2qve"),t.TokenBucket=n("ovfc")},"8oxB":function(e,t){var n,r,i=e.exports={};function a(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function u(e){if(n===setTimeout)return setTimeout(e,0);if((n===a||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:a}catch(e){n=a}try{r="function"==typeof clearTimeout?clearTimeout:o}catch(e){r=o}}();var c,l=[],s=!1,f=-1;function h(){s&&c&&(s=!1,c.length?l=c.concat(l):f=-1,l.length&&m())}function m(){if(!s){var e=u(h);s=!0;for(var t=l.length;t;){for(c=l,l=[];++f<t;)c&&c[f].run();f=-1,t=l.length}c=null,s=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===o||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function d(e,t){this.fun=e,this.array=t}function v(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new d(e,t)),1!==l.length||s||u(m)},d.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=v,i.addListener=v,i.once=v,i.off=v,i.removeListener=v,i.removeAllListeners=v,i.emit=v,i.prependListener=v,i.prependOnceListener=v,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},XsWv:function(e,t){var n=[{name:" second",value:1e3,max:50,single:"a second"},{name:" minute",value:6e4,max:50,single:"a minute"},{name:" hour",value:36e5,max:22,single:"an hour"},{name:" day",value:864e5,max:6,single:"a day"},{name:" week",value:6048e5,max:3.5,single:"a week"},{name:" month",value:2592e6,max:11,single:"a month"},{name:" year",value:31536e6,max:1/0,single:"a year"}];e.exports=function(e){var t=Date.now()-e.getTime(),r=t<0;if(t=Math.abs(t),!r&&t<1e4)return"just now";if(r&&t<5e3)return"any second";for(var i=r?" from now":" ago",a=0;a<n.length;a++){var o=n[a];if(t<=o.max*o.value){var u=Math.round(t/o.value);return 1===u?o.single+i:u+o.name+"s"+i}}}},kzmp:function(e,t,n){(function(t){e.exports=function(){if(void 0!==t&&t.hrtime){var e=t.hrtime(),n=e[0],r=e[1];return 1e3*n+Math.floor(r/1e6)}return(new Date).getTime()}}).call(this,n("8oxB"))},ovfc:function(e,t,n){(function(t){var n=function(e,t,n,r){if(this.bucketSize=e,this.tokensPerInterval=t,"string"==typeof n)switch(n){case"sec":case"second":this.interval=1e3;break;case"min":case"minute":this.interval=6e4;break;case"hr":case"hour":this.interval=36e5;break;case"day":this.interval=864e5;break;default:throw new Error("Invaid interval "+n)}else this.interval=n;this.parentBucket=r,this.content=0,this.lastDrip=+new Date};n.prototype={bucketSize:1,tokensPerInterval:1,interval:1e3,parentBucket:null,content:0,lastDrip:0,removeTokens:function(e,n){var r=this;return this.bucketSize?e>this.bucketSize?(t.nextTick(n.bind(null,"Requested tokens "+e+" exceeds bucket size "+this.bucketSize,null)),!1):(this.drip(),e>this.content?i():this.parentBucket?this.parentBucket.removeTokens(e,(function(t,a){return t?n(t,null):e>r.content?i():(r.content-=e,void n(null,Math.min(a,r.content)))})):(this.content-=e,t.nextTick(n.bind(null,null,this.content)),!0)):(t.nextTick(n.bind(null,null,e,Number.POSITIVE_INFINITY)),!0);function i(){var t=Math.ceil((e-r.content)*(r.interval/r.tokensPerInterval));return setTimeout((function(){r.removeTokens(e,n)}),t),!1}},tryRemoveTokens:function(e){return!this.bucketSize||!(e>this.bucketSize)&&(this.drip(),!(e>this.content)&&(!(this.parentBucket&&!this.parentBucket.tryRemoveTokens(e))&&(this.content-=e,!0)))},drip:function(){if(this.tokensPerInterval){var e=+new Date,t=Math.max(e-this.lastDrip,0);this.lastDrip=e;var n=t*(this.tokensPerInterval/this.interval);this.content=Math.min(this.content+n,this.bucketSize)}else this.content=this.bucketSize}},e.exports=n}).call(this,n("8oxB"))}});